name: 'Build and test'
description: 'Lint, build, test and generate coverage report'

inputs:
  minimum-coverage:
    required: false
    default: 50
    description: 'The minimum allowed coverage percentage as an integer'
  test-report-path:
    required: false
    default: ''
    description: 'The path to the test report. Must include "/" at the end'
  coverage-report-path:
    required: false
    default: ''
    description: 'The path to the coverage report. Must include "/" at the end'

runs:
  using: "composite"
  steps:
    - run: npm ci
      shell: bash
    - run: npm run lint
      shell: bash
    - run: npm run build
      shell: bash
    - run: npm run coverage:ci
      shell: bash
    - name: Publish Test Results
      uses: EnricoMi/publish-unit-test-result-action@v2
      if: always()
      with:
        junit_files: ${{inputs.test-report-path}}test-results.xml
    - name: Publish Cobertura coverage results
      uses: 5monkeys/cobertura-action@master
      if: ${{ github.event_name != 'workflow_dispatch' }}
      with:
        path: ${{inputs.coverage-report-path}}cobertura-coverage.xml
        report_name: Code Coverage
        show_line: true
        fail_below_threshold: false
        minimum_coverage: ${{ inputs.minimum-coverage }}
